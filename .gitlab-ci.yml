---
include:
  - project: SocialGouv/gitlab-ci-yml
    file: /autodevops_simple_app.yml
    ref: v9.1.1

variables:
  PROJECT: "carnets"
  PORT: 3000
  VALUES_FILE: ./.k8s/app.values.yml
  AUTH0_REDIRECT_URI: https://${CI_ENVIRONMENT_SLUG}-${CI_PROJECT_NAME}.${KUBE_INGRESS_BASE_DOMAIN}/api/callback
  AUTH0_POST_LOGOUT_REDIRECT_URI: https://${CI_ENVIRONMENT_SLUG}-${CI_PROJECT_NAME}.${KUBE_INGRESS_BASE_DOMAIN}
  HASURA_URL: https://hasura-${CI_ENVIRONMENT_SLUG}-${CI_PROJECT_NAME}.${KUBE_INGRESS_BASE_DOMAIN}/v1/graphql
  TEST_SIX: https://hasura-${CI_ENVIRONMENT_SLUG}-${CI_PROJECT_NAME}.${KUBE_INGRESS_BASE_DOMAIN}/v1/graphql
  ENABLE_AZURE_POSTGRES: 1
  TEST_TWO: "test number two"

Create Azure DB (dev):
  stage: Install
  extends:
    - .base_create_azure_db
  before_script:
    - echo "kubectl get secret azure-pg-admin-user -n ${CI_PROJECT_NAME}-secret"
    - kubectl get secret azure-pg-admin-user -n ${CI_PROJECT_NAME}-secret -o json | export_from_k8s_secret
    - \. <(kubectl get secret azure-pg-admin-user -n ${CI_PROJECT_NAME}-secret -o json | export_from_k8s_secret)
    - export PGHOST="${PG_HOST}"

Register image Hasura:
  extends: .base_register_stage
  stage: Registration
  variables:
    CONTEXT: ./packages/hasura
    DOCKERFILE_PATH: Dockerfile
    IMAGE_NAME: $CI_REGISTRY_IMAGE/hasura

Deploy app Hasura (dev):
  extends:
    - .deploy_app_stage
  except:
    refs:
      - tags
      - master
  variables:
    CONTEXT: hasura
    HOST: hasura-${CI_ENVIRONMENT_SLUG}-${CI_PROJECT_NAME}.${KUBE_INGRESS_BASE_DOMAIN}
    JWK_URL: http://${CI_ENVIRONMENT_SLUG}-${CI_PROJECT_NAME}.${KUBE_INGRESS_BASE_DOMAIN}/api/v2/auth/jwks
    VALUES_FILE: ./.k8s/hasura.values.yml
  environment:
    name: review/${CI_COMMIT_REF_NAME}-dev
    url: https://hasura-${CI_ENVIRONMENT_SLUG}-${CI_PROJECT_NAME}.${KUBE_INGRESS_BASE_DOMAIN}

Deploy app Hasura (prod):
  extends:
    - .deploy_app_stage
  only:
    refs:
      - master
  variables:
    CONTEXT: hasura
    HOST: hasura-${CI_PROJECT_NAME}.${KUBE_INGRESS_BASE_DOMAIN}
    JWK_URL: http://${CI_PROJECT_NAME}.${KUBE_INGRESS_BASE_DOMAIN}/api/v2/auth/jwks
    VALUES_FILE: ./.k8s/hasura.values.yml
    K8S_NAMESPACE: ${CI_PROJECT_NAME}
    PRODUCTION: "true"
  environment:
    name: prod
    url: https://hasura-${CI_PROJECT_NAME}.${KUBE_INGRESS_BASE_DOMAIN}
