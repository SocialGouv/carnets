name: üöÄ Production
on:
  workflow_dispatch:
  push:
    tags:
      - v*

concurrency:
  group: production
  cancel-in-progress: true

jobs:
  env:
    runs-on: ubuntu-latest
    outputs:
      subdomain_hasura: ${{ steps.env.outputs.subdomain_hasura }}
    steps:
      - name: Env
        id: env
        uses: socialgouv/kontinuous/.github/actions/env@v1
        with:
          subdomain: hasura

  build-app:
    needs: [env]
    uses: socialgouv/workflows/.github/workflows/use-buildkit.yaml@v1
    with:
      environment: production
      image-name: app
      context: "."
      dockerfile: "Dockerfile"
      build-args: |
        NEXT_PUBLIC_HASURA_URL=https://${{ needs.env.outputs.subdomain_hasura }}/v1/graphql
        NEXT_PUBLIC_MATOMO_SITE_ID=24
        NEXT_PUBLIC_MATOMO_URL=https://matomo.fabrique.social.gouv.fr/
      secrets: |
        sentry_auth_token=${{ secrets.SENTRY_AUTH_TOKEN }}
    secrets: inherit

  build-hasura:
    uses: socialgouv/workflows/.github/workflows/use-buildkit.yaml@v1
    with:
      environment: production
      image-name: hasura
      context: "./packages/hasura"
      dockerfile: "Dockerfile"
    secrets: inherit

  kontinuous:
    needs: [build-app, build-hasura]
    name: "Deploy on Kubernetes üê≥"
    uses: socialgouv/workflows/.github/workflows/use-ks-gh-production-atlas.yaml@v1
    secrets: inherit
